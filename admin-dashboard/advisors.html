<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>陪同顾问管理 - 管理后台</title>
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
      font-family: "Helvetica Neue", Helvetica, "PingFang SC", Arial, sans-serif;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    .header h1 {
      margin: 0;
      font-size: 28px;
    }
    .header p {
      margin: 10px 0 0 0;
      opacity: 0.9;
    }
    .content-wrapper {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }
    .advisor-list-panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
    }
    .schedule-panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
      height: fit-content;
    }
    .advisor-card {
      border: 1px solid #e4e7ed;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    .advisor-card:hover {
      box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
    }
    .advisor-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    .advisor-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }
    .advisor-info {
      flex: 1;
    }
    .advisor-name {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 5px;
    }
    .advisor-title {
      color: #909399;
      font-size: 14px;
    }
    .advisor-stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #409eff;
    }
    .stat-label {
      font-size: 12px;
      color: #909399;
      margin-top: 3px;
    }
    .schedule-table {
      margin-top: 20px;
    }
    .schedule-day {
      margin-bottom: 15px;
    }
    .schedule-day-title {
      font-weight: 500;
      margin-bottom: 8px;
      color: #303133;
    }
    .time-slots {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .time-slot {
      padding: 8px;
      text-align: center;
      border: 1px solid #dcdfe6;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 13px;
    }
    .time-slot.available {
      background: #f0f9ff;
      border-color: #409eff;
      color: #409eff;
    }
    .time-slot.unavailable {
      background: #f5f5f5;
      color: #c0c4cc;
      cursor: not-allowed;
    }
    .advisor-tags {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .internal-badge {
      background: #fef0f0;
      color: #f56c6c;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .add-advisor-btn {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="header">
      <h1>👥 陪同顾问管理</h1>
      <p>管理医疗陪同顾问信息和排班</p>
    </div>

    <div class="content-wrapper">
      <!-- 顾问列表 -->
      <div class="advisor-list-panel">
        <el-button type="primary" @click="showAddDialog" class="add-advisor-btn">
          + 添加顾问
        </el-button>

        <div v-for="advisor in advisors" :key="advisor.id" class="advisor-card">
          <div class="advisor-header">
            <div class="advisor-avatar">
              {{ advisor.name.charAt(0) }}
            </div>
            <div class="advisor-info">
              <div class="advisor-name">
                {{ advisor.name }}
                <el-tag size="mini" v-if="advisor.status === 'inactive'" type="danger">已停用</el-tag>
              </div>
              <div class="advisor-title">{{ advisor.title }}</div>
            </div>
            <div class="advisor-actions">
              <el-button size="small" @click="editAdvisor(advisor)">编辑</el-button>
              <el-button size="small" @click="manageSchedule(advisor)">排班</el-button>
              <el-button size="small" type="danger" @click="deleteAdvisor(advisor)">删除</el-button>
            </div>
          </div>

          <div class="advisor-stats">
            <div class="stat-item">
              <div class="stat-value">{{ advisor.rating || 5.0 }}</div>
              <div class="stat-label">评分</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ advisor.serviceCount || 0 }}</div>
              <div class="stat-label">服务次数</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">{{ advisor.experience }}</div>
              <div class="stat-label">经验</div>
            </div>
          </div>

          <div class="advisor-tags">
            <el-tag size="mini" v-for="tag in advisor.tags" :key="tag">{{ tag }}</el-tag>
            <!-- 内部标记（仅管理员可见） -->
            <span class="internal-badge" v-if="advisor.internal && advisor.internal.type === 'senior'">
              资深（中韩）
            </span>
          </div>
        </div>
      </div>

      <!-- 排班管理面板 -->
      <div class="schedule-panel" v-if="currentScheduleAdvisor">
        <h3>排班管理 - {{ currentScheduleAdvisor.name }}</h3>

        <el-date-picker
          v-model="scheduleDate"
          type="date"
          placeholder="选择日期"
          @change="loadSchedule"
          style="width: 100%; margin-bottom: 20px">
        </el-date-picker>

        <div class="schedule-table">
          <div class="schedule-day">
            <div class="schedule-day-title">{{ formatDate(scheduleDate) }} 排班</div>
            <div class="time-slots">
              <div v-for="slot in timeSlots" :key="slot.time"
                :class="['time-slot', slot.available ? 'available' : 'unavailable']"
                @click="toggleSlot(slot)">
                {{ slot.time }}
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <el-button type="primary" @click="saveSchedule" size="small">保存排班</el-button>
          <el-button @click="currentScheduleAdvisor = null" size="small">关闭</el-button>
        </div>
      </div>
    </div>

    <!-- 添加/编辑顾问对话框 -->
    <el-dialog :title="editMode === 'add' ? '添加顾问' : '编辑顾问'"
      :visible.sync="dialogVisible" width="600px">
      <el-form :model="currentAdvisor" label-width="100px">
        <el-form-item label="姓名">
          <el-input v-model="currentAdvisor.name" placeholder="请输入顾问姓名"></el-input>
        </el-form-item>
        <el-form-item label="职称">
          <el-select v-model="currentAdvisor.title" placeholder="请选择">
            <el-option label="资深医疗顾问" value="资深医疗顾问"></el-option>
            <el-option label="医疗顾问" value="医疗顾问"></el-option>
            <el-option label="医疗助理" value="医疗助理"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="经验">
          <el-input v-model="currentAdvisor.experience" placeholder="例如：3年"></el-input>
        </el-form-item>
        <el-form-item label="专长">
          <el-input v-model="currentAdvisor.specialty" placeholder="例如：整形外科陪同"></el-input>
        </el-form-item>
        <el-form-item label="标签">
          <el-select v-model="currentAdvisor.tags" multiple placeholder="请选择标签">
            <el-option label="专业" value="专业"></el-option>
            <el-option label="细心" value="细心"></el-option>
            <el-option label="经验丰富" value="经验丰富"></el-option>
            <el-option label="耐心" value="耐心"></el-option>
            <el-option label="负责" value="负责"></el-option>
            <el-option label="友善" value="友善"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="内部备注">
          <el-input type="textarea" v-model="currentAdvisor.internalNote"
            placeholder="仅内部可见，可以备注语言能力等信息"></el-input>
        </el-form-item>
        <el-form-item label="类型">
          <el-radio-group v-model="currentAdvisor.type">
            <el-radio label="senior">资深顾问（懂中韩双语）</el-radio>
            <el-radio label="basic">标准顾问</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="saveAdvisor">确定</el-button>
      </span>
    </el-dialog>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        advisors: [],
        dialogVisible: false,
        editMode: 'add',
        currentAdvisor: {
          name: '',
          title: '医疗顾问',
          experience: '',
          specialty: '',
          tags: [],
          type: 'senior',
          internalNote: ''
        },
        currentScheduleAdvisor: null,
        scheduleDate: new Date(),
        timeSlots: [],
        apiUrl: 'https://beauty-clinic-backend.vercel.app'
      },
      mounted() {
        this.loadAdvisors();
        this.initTimeSlots();
      },
      methods: {
        // 加载顾问列表
        async loadAdvisors() {
          try {
            const response = await axios.get(`${this.apiUrl}/api/advisors/list`);
            if (response.data.success) {
              this.advisors = response.data.data;
            }
          } catch (error) {
            console.error('加载顾问列表失败:', error);
            this.$message.error('加载顾问列表失败');
          }
        },

        // 初始化时间段
        initTimeSlots() {
          const slots = [
            '09:00-11:00',
            '11:00-13:00',
            '14:00-16:00',
            '16:00-18:00',
            '18:00-20:00',
            '20:00-22:00'
          ];
          this.timeSlots = slots.map(time => ({
            time: time,
            available: true
          }));
        },

        // 显示添加对话框
        showAddDialog() {
          this.editMode = 'add';
          this.currentAdvisor = {
            name: '',
            title: '医疗顾问',
            experience: '',
            specialty: '',
            tags: [],
            type: 'senior',
            internalNote: ''
          };
          this.dialogVisible = true;
        },

        // 编辑顾问
        editAdvisor(advisor) {
          this.editMode = 'edit';
          this.currentAdvisor = { ...advisor };
          this.dialogVisible = true;
        },

        // 保存顾问
        async saveAdvisor() {
          try {
            if (this.editMode === 'add') {
              const response = await axios.post(`${this.apiUrl}/api/advisors/add`, {
                ...this.currentAdvisor,
                languages: this.currentAdvisor.type === 'senior' ? ['zh', 'kr'] : ['zh']
              });
              if (response.data.success) {
                this.$message.success('添加成功');
                this.loadAdvisors();
              }
            } else {
              const response = await axios.put(
                `${this.apiUrl}/api/advisors/update/${this.currentAdvisor.id}`,
                this.currentAdvisor
              );
              if (response.data.success) {
                this.$message.success('更新成功');
                this.loadAdvisors();
              }
            }
            this.dialogVisible = false;
          } catch (error) {
            console.error('保存失败:', error);
            this.$message.error('保存失败');
          }
        },

        // 删除顾问
        deleteAdvisor(advisor) {
          this.$confirm('确定要删除这个顾问吗？', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }).then(async () => {
            try {
              const response = await axios.delete(
                `${this.apiUrl}/api/advisors/delete/${advisor.id}`
              );
              if (response.data.success) {
                this.$message.success('删除成功');
                this.loadAdvisors();
              }
            } catch (error) {
              console.error('删除失败:', error);
              this.$message.error('删除失败');
            }
          }).catch(() => {});
        },

        // 管理排班
        manageSchedule(advisor) {
          this.currentScheduleAdvisor = advisor;
          this.loadSchedule();
        },

        // 加载排班
        async loadSchedule() {
          if (!this.currentScheduleAdvisor) return;

          try {
            const date = this.formatDateForApi(this.scheduleDate);
            const response = await axios.get(
              `${this.apiUrl}/api/advisors/schedule/${this.currentScheduleAdvisor.id}?date=${date}`
            );

            // 更新时间段状态
            if (response.data.success && response.data.data.schedules[date]) {
              const schedule = response.data.data.schedules[date];
              this.timeSlots = this.timeSlots.map(slot => {
                const found = schedule.find(s => s.time === slot.time);
                return found || slot;
              });
            } else {
              this.initTimeSlots();
            }
          } catch (error) {
            console.error('加载排班失败:', error);
          }
        },

        // 切换时间段状态
        toggleSlot(slot) {
          slot.available = !slot.available;
        },

        // 保存排班
        async saveSchedule() {
          try {
            const date = this.formatDateForApi(this.scheduleDate);
            const response = await axios.post(`${this.apiUrl}/api/advisors/schedule`, {
              advisorId: this.currentScheduleAdvisor.id,
              date: date,
              slots: this.timeSlots
            });

            if (response.data.success) {
              this.$message.success('排班保存成功');
            }
          } catch (error) {
            console.error('保存排班失败:', error);
            this.$message.error('保存排班失败');
          }
        },

        // 格式化日期
        formatDate(date) {
          const d = new Date(date);
          const weekDays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
          return `${d.getMonth() + 1}月${d.getDate()}日 ${weekDays[d.getDay()]}`;
        },

        // 格式化日期用于API
        formatDateForApi(date) {
          const d = new Date(date);
          return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }
      }
    });
  </script>
</body>
</html>